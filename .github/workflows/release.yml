name: Release

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      formula:
        required: false
        type: string

env:
  HOMEBREW_DEVELOPER: 1
  HOMEBREW_NO_AUTO_UPDATE: 1

permissions:
  contents: read

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      formulas: ${{ steps.setup.outputs.formulas }}
      date: ${{ steps.setup.outputs.date }}
    steps:
      - uses: actions/checkout@main
      - run: date
      - run: date +%Y%m%d
      - id: setup
        run: |
          list=$(ls Formula/rv-ruby* | jq --raw-input | jq --slurp --compact-output 'map(. |= .[8:-3])')
          if [[ -n "${{ inputs.formula }}" ]]; then
            # if we passed a string, only build matches
            list=$(echo $list | jq --compact-output 'map(select(. | contains("${{ inputs.formula }}")))')
          else
            # without a filter, build all but rv-ruby-dev
            list=${list/'"'rv-ruby-dev'"',/}
          fi
          echo 'setting $formulas to:'
          echo "$list"
          echo formulas=$list >> "$GITHUB_OUTPUT"
          echo "date=$(date +%Y%m%d)" >> "$GITHUB_OUTPUT"

  build-homebrew:
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        formula: ${{ fromJSON(needs.setup.outputs.formulas) }}
    uses: ./.github/workflows/build.yml
    with:
      formula: ${{ matrix.formula }}

  build-alpine:
    if: ${{ needs.setup.outputs.formulas != '["rv-ruby-dev"]' }}
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        formula: ${{ fromJSON(needs.setup.outputs.formulas) }}
    uses: ./.github/workflows/build-alpine.yml
    with:
      formula: ${{ matrix.formula }}

  release:
    needs: [setup, build-homebrew, build-alpine]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    env:
      TAG: ${{ needs.setup.outputs.date }}
    steps:
      - name: Fail if required builds failed
        if: ${{ needs.build-alpine.result == 'failure' }}
        run: exit 1
      - uses: actions/checkout@main
      - name: Install Homebrew
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew tap spinel-coop/rv-ruby .

      - name: Checkout branch
        run: git checkout "${GITHUB_REF_NAME}"

      - name: Install gems
        run: brew install-bundler-gems --groups=pr_upload

      - name: Configure Git user
        uses: Homebrew/actions/git-user-config@main

      - name: Setup directory
        run: mkdir rubies

      - name: Download rubies
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: rv-ruby*
          path: rubies
          merge-multiple: true

      - name: Upload to GitHub Packages
        if: ${{ inputs.formula == '' }}
        working-directory: rubies
        env:
          HOMEBREW_GITHUB_PACKAGES_USER: ${{ github.actor }}
          HOMEBREW_GITHUB_PACKAGES_TOKEN: ${{ github.token }}
        run: brew rv-upload --debug --root-url="https://ghcr.io/v2/${GITHUB_REPOSITORY,,}"

      - name: Push tag
        if: ${{ inputs.formula == '' }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          gh release create "${TAG}" --notes "rv ruby ${TAG}" --target "$(git rev-parse --verify HEAD)" --title "${TAG}" --prerelease

      - name: Upload Homebrew bottles to GitHub Releases
        if: ${{ inputs.formula == '' }}
        working-directory: rubies
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ github.token }}
        run: brew rv-upload --debug --root-url="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}"

      - name: Upload Alpine tarballs to GitHub Releases
        if: ${{ inputs.formula == '' }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          for f in rubies/*musl*.tar.gz; do
            [ -f "$f" ] || continue
            echo "Uploading Alpine artifact: $f"
            gh release upload "${TAG}" "$f" --clobber
          done

      - name: Release
        if: ${{ inputs.formula == '' }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          gh release edit "${TAG}" --verify-tag --prerelease=false --latest

      - name: Cleanup
        run: rm -rvf rubies
