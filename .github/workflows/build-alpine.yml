name: Build Alpine

on:
  workflow_dispatch:
    inputs:
      formula:
        description: "Formula to build (e.g., rv-ruby@3.4.8)"
        required: true
        type: string
  workflow_call:
    inputs:
      formula:
        required: true
        type: string

env:
  # Pinned, not :latest â€” the Alpine version determines the minimum Alpine
  # version users can run these binaries on (forward-compatible but not backward).
  # 3.21 was released Dec 2024 and is supported until Nov 2026.
  # Bump when the current version approaches EOL.
  # See: https://alpinelinux.org/releases/
  ALPINE_IMAGE: alpine:3.21

permissions:
  contents: read

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            arch: x86_64
          - runner: ubuntu-24.04-arm
            arch: aarch64
    runs-on: ${{ matrix.runner }}
    # Note: we use `docker run` in steps instead of `container:` because
    # GitHub's JS-based actions (checkout, upload-artifact) don't support
    # Alpine containers on ARM runners.
    steps:
      - uses: actions/checkout@main

      - name: Build Ruby
        run: |
          docker run --rm -v "$GITHUB_WORKSPACE:/src" -w /src ${{ env.ALPINE_IMAGE }} sh -c '
            bin/package-alpine "${{ inputs.formula }}"
          '

      - name: Upload artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: ${{ hashFiles('rubies/') != '' }}
        with:
          name: ${{ inputs.formula }}_alpine-${{ matrix.arch }}
          path: rubies/*.tar.gz

      - name: Test Ruby on clean Alpine
        if: ${{ hashFiles('rubies/') != '' }}
        run: |
          docker run --rm -v "$GITHUB_WORKSPACE:/src" -w /src ${{ env.ALPINE_IMAGE }} sh -c '
            set -eu
            mkdir -p test-ruby/
            tar --strip-components 2 -C test-ruby -xf rubies/*.tar.gz
            export PATH="${PWD}/test-ruby/bin:${PATH}"
            ruby --version
            ruby -e "puts RUBY_DESCRIPTION"
            ruby -rzlib -e "puts Zlib.crc32(\"test\")"
            ruby -ryaml -e "puts YAML.load(\"test: 1\")"
            ruby -ropenssl -e "puts OpenSSL::Digest::SHA256.hexdigest(\"test\")"
            ruby -rreadline -e "puts Readline::VERSION"
            ruby -rfiddle -e "puts Fiddle::RUBY_FREE"
            ruby -e "puts Gem.default_dir"
            echo "All extension tests passed."
          '
