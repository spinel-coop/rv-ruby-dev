#!/bin/bash

NUMBER="$1"

export HOMEBREW_RUSTUP_HOME="$HOME/.rustup"

if [[ "0.49" != "$NUMBER" && "head" != "$NUMBER" ]]; then
  export HOMEBREW_BASERUBY="$HOME/.rubies/ruby-${NUMBER}/bin/ruby"
fi

if [[ -n "$HOMEBREW_BASERUBY" && ! -f "$HOMEBREW_BASERUBY" ]]; then
  brew install ruby-install
  (which apt && sudo apt update) || true
  ruby-install "$NUMBER"
fi

if [[ "head" == "$NUMBER" ]]; then
  PACKAGE="rv-ruby-head"
else
  PACKAGE="rv-ruby@${NUMBER}"
fi

set -v
brew uninstall --force "$PACKAGE"
brew rv-package "$PACKAGE" \
  --no-uninstall-deps \
  --debug \
  --verbose \
  --with-yjit
