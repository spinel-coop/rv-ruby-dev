#!/bin/bash

NUMBER="$1"

set -v

export HOMEBREW_BASERUBY="$HOME/.rubies/ruby-${NUMBER}/bin/ruby"
export HOMEBREW_RUSTUP_HOME="$HOME/.rustup"

if [[ (! -f "$HOMEBREW_BASERUBY") && "0.49" != "$NUMBER" && "head" != "$NUMBER" ]]; then
  brew install ruby-install
  (which apt && sudo apt update) || true
  ruby-install "$NUMBER"
fi

if [[ "head" == "$NUMBER" ]]; then
  PACKAGE="rv-ruby"
  FLAGS="--HEAD"
else
  PACKAGE="rv-ruby@${NUMBER}"
  FLAGS=""
  brew uninstall --force "$PACKAGE"
fi

brew rv-package "$PACKAGE" "$FLAGS" \
  --no-uninstall-deps \
  --debug \
  --verbose \
  --with-yjit
